<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Control de Viaje</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --bg: #0b1220;
  --panel: rgba(255,255,255,.06);
  --border: rgba(255,255,255,.10);
  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.68);

  --expected-bg: rgba(255, 199, 0, .14);
  --expected-br: rgba(255, 199, 0, .35);
  --expected-tx: rgba(255, 230, 140, .95);

  --spent-bg: rgba(0, 240, 120, .12);
  --spent-br: rgba(0, 240, 120, .30);
  --spent-tx: rgba(170, 255, 210, .95);

  --danger-bg: rgba(255, 70, 90, .14);
  --danger-br: rgba(255, 70, 90, .32);
  --danger-tx: rgba(255, 170, 178, .98);

  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --radius: 16px;
  --radius-sm: 12px;
}

*{ box-sizing: border-box; }
html, body{ height: 100%; }
body{
  margin:0;
  font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: var(--text);
  background:
    radial-gradient(1100px 600px at 20% 10%, rgba(112, 153, 255, .18), transparent 55%),
    radial-gradient(900px 500px at 80% 20%, rgba(255, 198, 89, .14), transparent 60%),
    radial-gradient(900px 500px at 60% 90%, rgba(0, 240, 120, .10), transparent 60%),
    var(--bg);
  padding: 18px;
}

.container{ max-width: 980px; margin: 0 auto; }

.header{
  display:flex;
  align-items:flex-end;
  justify-content: space-between;
  gap: 14px;
  margin-bottom: 14px;
}
.header h1{
  margin:0;
  font-size: 26px;
  letter-spacing: -0.02em;
}
.header p{
  margin: 6px 0 0 0;
  color: var(--muted);
  font-size: 13px;
}

.toolbar{
  display:flex;
  gap: 10px;
  align-items:center;
  flex-wrap: wrap;
}

.btn{
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  color: var(--text);
  border-radius: 12px;
  padding: 10px 12px;
  cursor: pointer;
  font-weight: 700;
  transition: transform .08s ease, background .15s ease, border-color .15s ease;
  white-space: nowrap;
}
.btn:hover{
  background: rgba(255,255,255,.10);
  border-color: rgba(255,255,255,.26);
}
.btn:active{ transform: translateY(1px) scale(.99); }
.btnPrimary{
  border-color: rgba(112,153,255,.45);
  background: rgba(112,153,255,.14);
}

.section{
  background: linear-gradient(180deg, var(--panel), rgba(255,255,255,.03));
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 14px;
  margin-bottom: 14px;
  backdrop-filter: blur(10px);
}

/* chip "te queda" */
.balanceWrap{
  display:flex;
  justify-content: flex-start;
  margin: 8px 0 12px;
}
.balancePill{
  display:inline-flex;
  align-items:center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  cursor: pointer;
  user-select: none;
  transition: transform .08s ease, background .15s ease, border-color .15s ease;
}
.balancePill:hover{
  background: rgba(255,255,255,.10);
  border-color: rgba(255,255,255,.22);
}
.balancePill:active{ transform: translateY(1px); }

.balancePill .label{
  font-size: 12px;
  color: var(--muted);
  font-weight: 800;
}
.balancePill .value{
  font-size: 14px;
  font-weight: 900;
  letter-spacing: -0.01em;
}
.balancePill .hint{
  font-size: 12px;
  color: rgba(255,255,255,.55);
  font-weight: 700;
}
.balanceOk{ border-color: var(--spent-br); background: rgba(0,240,120,.10); }
.balanceOk .value{ color: var(--spent-tx); }
.balanceWarn{ border-color: var(--danger-br); background: rgba(255,70,90,.10); }
.balanceWarn .value{ color: var(--danger-tx); }

/* Resumen global */
.heroTotals{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap: 12px;
  margin-bottom: 14px;
}
.heroCard{
  border-radius: var(--radius);
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  padding: 14px;
}
.heroCard .label{
  color: var(--muted);
  font-size: 12px;
  margin-bottom: 10px;
  display:flex;
  justify-content: space-between;
  gap: 10px;
}
.heroCard .value{
  font-size: 22px;
  font-weight: 900;
  letter-spacing: -0.02em;
}
.heroSpent{ border-color: var(--spent-br); background: linear-gradient(180deg, var(--spent-bg), rgba(255,255,255,.03)); }
.heroSpent .value{ color: var(--spent-tx); }

.heroExpected{ border-color: var(--expected-br); background: linear-gradient(180deg, var(--expected-bg), rgba(255,255,255,.03)); }
.heroExpected .value{ color: var(--expected-tx); }

.heroTotal{ border-color: rgba(255,255,255,.16); background: rgba(255,255,255,.06); }

/* Secciones */
.sectionHead{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  padding: 4px 6px 10px;
  border-bottom: 1px solid rgba(255,255,255,.08);
  margin-bottom: 10px;
}
.sectionTitle{ display:flex; flex-direction: column; gap: 2px; }
.sectionTitle h2{ margin:0; font-size: 16px; letter-spacing: -0.01em; }
.sectionTitle span{ color: var(--muted); font-size: 12px; }

.btnPlus{
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  color: var(--text);
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
  font-weight: 800;
}

.items{ display:flex; flex-direction: column; gap: 8px; }

.item{
  display:grid;
  grid-template-columns: 1fr auto;
  align-items:center;
  gap: 10px;
  padding: 10px 10px;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.04);
  cursor: pointer;
  transition: transform .08s ease, background .15s ease, border-color .15s ease;
}
.item:hover{ background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.14); }
.item:active{ transform: translateY(1px); }

.item.expected{
  background: linear-gradient(180deg, var(--expected-bg), rgba(255,255,255,.03));
  border-color: var(--expected-br);
}
.item.spent{
  background: linear-gradient(180deg, var(--spent-bg), rgba(255,255,255,.03));
  border-color: var(--spent-br);
}

.itemDesc{ display:flex; flex-direction: column; gap: 4px; min-width: 0; }
.itemDesc .name{
  font-weight: 700;
  font-size: 14px;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.itemDesc .sub{
  font-size: 12px;
  color: var(--muted);
  display:flex;
  gap: 10px;
  flex-wrap: wrap;
}
.badge{
  font-size: 11px;
  font-weight: 800;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(0,0,0,.18);
}
.badgeSpent{ border-color: var(--spent-br); color: var(--spent-tx); background: rgba(0,240,120,.10); }
.badgeExpected{ border-color: var(--expected-br); color: var(--expected-tx); background: rgba(255,199,0,.10); }
.badgeCard{
  border-color: rgba(112,153,255,.45);
  background: rgba(112,153,255,.12);
  color: rgba(220,235,255,.95);
}

.priceChip{
  display:flex;
  align-items: center;
  gap: 8px;
  padding: 7px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.18);
  font-weight: 900;
  letter-spacing: .01em;
  white-space: nowrap;
}
.priceChip small{ font-weight: 800; color: var(--muted); }

/* Totales por secci√≥n */
.sectionTotals{
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px dashed rgba(255,255,255,.12);
  display:grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap: 10px;
}
.tCard{
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  border-radius: 14px;
  padding: 10px 12px;
}
.tCard .label{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 8px;
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
}
.tCard .value{
  font-size: 16px;
  font-weight: 900;
  letter-spacing: -0.01em;
}
.tExpected{ border-color: var(--expected-br); background: var(--expected-bg); }
.tExpected .value{ color: var(--expected-tx); }
.tSpent{ border-color: var(--danger-br); background: var(--danger-bg); }
.tSpent .value{ color: var(--danger-tx); }
.tAll{ border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.06); }
.tCardCard{ border-color: rgba(112,153,255,.35); background: rgba(112,153,255,.10); }
.tCardCard .value{ color: rgba(220,235,255,.95); }

@media (max-width: 820px){
  .heroTotals{ grid-template-columns: 1fr; }
  .sectionTotals{ grid-template-columns: 1fr; }
  .header{ flex-direction: column; align-items: flex-start; }
  .itemDesc .name{ white-space: normal; }
}
</style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>‚úàÔ∏è Viaje ‚Äì Control de Gastos</h1>
        <p>Click en un √≠tem para editar o marcar como gastado. Toc√° ‚ÄúTe queda‚Äù para setear tu dinero inicial.</p>
      </div>
      <div class="toolbar">
        <button class="btn btnPrimary" onclick="exportPDF()">üìÑ Exportar PDF</button>
        <button class="btn" onclick="downloadJSON()">‚¨á Exportar JSON</button>
        <button class="btn" onclick="triggerImport()">‚¨Ü Importar JSON</button>
        <button class="btn" onclick="resetData()">üßπ Reset</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </div>

    <div id="hero"></div>
    <div id="app"></div>
  </div>

<script>
/* ==========================
   CONFIG / DEFAULT
========================== */
const CATEGORY_ORDER = ["Ropa", "Comida", "Electr√≥nica", "Entretenimiento"];

const dataDefault = {
  sections: {
    "Ropa": [],
    "Comida": [],
    "Electr√≥nica": [],
    "Entretenimiento": []
  }
};

let data = JSON.parse(localStorage.getItem("viajeData")) || dataDefault;

// dinero inicial
const BUDGET_KEY = "viajeBudgetUSD";
let budgetUSD = Number(localStorage.getItem(BUDGET_KEY)) || 0;

function save() {
  localStorage.setItem("viajeData", JSON.stringify(data));
  localStorage.setItem(BUDGET_KEY, String(budgetUSD || 0));
}

function nowISO(){ return new Date().toISOString(); }

function fmtDate(iso){
  if(!iso) return "‚Äî";
  return new Date(iso).toLocaleString("es-AR", {
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit"
  });
}

function fmtMoney(n){
  const num = Number(n) || 0;
  return num.toLocaleString("es-AR", { maximumFractionDigits: 2 });
}

/* ==========================
   MIGRACI√ìN A CATEGOR√çAS
   (por si import√°s / ten√©s data vieja)
========================== */
function ensureCategorySkeleton(obj){
  const out = { sections: {} };
  for (const c of CATEGORY_ORDER) out.sections[c] = [];
  if (obj && obj.sections){
    for (const c of CATEGORY_ORDER){
      if (Array.isArray(obj.sections[c])) out.sections[c] = obj.sections[c];
    }
  }
  return out;
}

function originSuffixFromSection(sectionName){
  const s = String(sectionName || "").toLowerCase();
  if (s.includes("miami")) return "_miami";
  if (s.includes("new york") || s.includes("ny")) return "_ny";
  if (s.includes("orlando")) return "_orlando";
  return "";
}

function normalizePayment(payment, desc){
  if (payment === "card" || payment === "cash") return payment;
  const d = String(desc || "").toLowerCase();
  if (d.includes("tarjeta") || d.includes("card") || d.includes("credit")) return "card";
  return "cash";
}

function cleanDesc(desc){
  return String(desc || "").replace(/_tarjetacredito/gi, "").trim();
}

function classifyCategory(desc){
  const d = String(desc || "").toLowerCase();

  // Electr√≥nica
  if (/(macbook|iphone|airpods|ipad|laptop|notebook|cargador|adapter|adaptador|usb|auricular)/i.test(d)) return "Electr√≥nica";

  // Ropa
  if (/(ropa|outlet|remera|pantal|campera|buzo|hoodie|zapa|zapat|nike|jordan|under\s*armor|abercrombie|calzon|calzonc|medias|north\s*face|columbia|polar|sweater|jean|short|shirt|t-shirt|sock)/i.test(d)) return "Ropa";

  // Comida
  if (/(comida|desayuno|almuerzo|cena|cafe|caf√©|latte|restaurant|burger|pizza|taco|chipotle|starbucks|agua|soda|pepsi|coca|publix|walmart|sedano|supermarket|snack|helado|ice\s*cream)/i.test(d)) return "Comida";

  // Default
  return "Entretenimiento";
}

function migrateToCategoriesIfNeeded(obj){
  if(!obj || !obj.sections) return ensureCategorySkeleton(obj);

  const keys = Object.keys(obj.sections);
  const alreadyCategorized =
    CATEGORY_ORDER.every(k => keys.includes(k)) &&
    keys.length === CATEGORY_ORDER.length;

  if (alreadyCategorized) {
    // asegurar campos
    for (const c of CATEGORY_ORDER){
      obj.sections[c] = (obj.sections[c] || []).map(it => ({
        desc: cleanDesc(it.desc),
        amount: Number(it.amount) || 0,
        status: (it.status === "spent") ? "spent" : "expected",
        payment: normalizePayment(it.payment, it.desc),
        updatedAt: it.updatedAt ?? null
      }));
    }
    return obj;
  }

  // migrar desde secciones viejas
  const out = ensureCategorySkeleton({});
  for (const oldSection in obj.sections){
    const suffix = originSuffixFromSection(oldSection);
    const items = Array.isArray(obj.sections[oldSection]) ? obj.sections[oldSection] : [];

    for (const it of items){
      const baseDesc = cleanDesc(it.desc);
      const payment = normalizePayment(it.payment, it.desc);
      const newDesc = suffix ? `${baseDesc}${suffix}` : baseDesc;

      const cat = classifyCategory(newDesc);
      out.sections[cat].push({
        desc: newDesc,
        amount: Number(it.amount) || 0,
        status: (it.status === "spent") ? "spent" : "expected",
        payment,
        updatedAt: it.updatedAt ?? null
      });
    }
  }

  return out;
}

// aplico migraci√≥n apenas carga
data = migrateToCategoriesIfNeeded(data);
save();

/* ==========================
   TOTALES
========================== */
function computeTotals(){
  let expected = 0;
  let spent = 0;
  let cardSpent = 0;

  for(const section in data.sections){
    for(const item of data.sections[section]){
      const amt = Number(item.amount) || 0;
      if(item.status === "expected") expected += amt;
      if(item.status === "spent") {
        spent += amt;
        if(item.payment === "card") cardSpent += amt;
      }
    }
  }
  return { expected, spent, cardSpent, total: expected + spent };
}

/* ==========================
   UI: Presupuesto
========================== */
function editBudget(){
  const current = budgetUSD || 0;
  const raw = prompt(
    "Ingres√° tu dinero inicial (USD).\n\nTip: si despu√©s ten√©s m√°s plata, sub√≠ este n√∫mero y listo.",
    String(current)
  );
  if(raw === null) return;
  const val = Number(String(raw).replace(",", "."));
  if(!Number.isFinite(val) || val < 0) return;
  budgetUSD = val;
  save();
  render();
}

function renderHero(){
  const hero = document.getElementById("hero");
  const t = computeTotals();

  const remaining = (budgetUSD || 0) - t.spent;
  const hasBudget = (budgetUSD || 0) > 0;

  const balanceClass = !hasBudget ? "" : (remaining >= 0 ? "balanceOk" : "balanceWarn");
  const balanceText = !hasBudget ? "Toc√° para setear" : `USD ${fmtMoney(remaining)}`;
  const hintText = !hasBudget ? "Dinero inicial" : `Inicial: USD ${fmtMoney(budgetUSD)}`;

  hero.innerHTML = `
    <div class="balanceWrap">
      <div class="balancePill ${balanceClass}" onclick="editBudget()">
        <span class="label">üí∏ Te queda</span>
        <span class="value">${balanceText}</span>
        <span class="hint">(${hintText})</span>
      </div>
    </div>

    <div class="heroTotals">
      <div class="heroCard heroSpent">
        <div class="label"><span>üü¢ Gastado (hasta ahora)</span><span>Global</span></div>
        <div class="value">USD ${fmtMoney(t.spent)}</div>
      </div>

      <div class="heroCard heroTotal">
        <div class="label"><span>üí≥ Gastado con tarjeta</span><span>Global</span></div>
        <div class="value">USD ${fmtMoney(t.cardSpent)}</div>
      </div>

      <div class="heroCard heroExpected">
        <div class="label"><span>üü° Esperado (por gastar)</span><span>Global</span></div>
        <div class="value">USD ${fmtMoney(t.expected)}</div>
      </div>

      <div class="heroCard heroTotal">
        <div class="label"><span>üí∞ Total (plan completo)</span><span>Global</span></div>
        <div class="value">USD ${fmtMoney(t.total)}</div>
      </div>
    </div>
  `;
}

/* ==========================
   RENDER
========================== */
function render() {
  renderHero();

  const app = document.getElementById("app");
  app.innerHTML = "";

  // asegurar orden de categor√≠as
  for (const section of CATEGORY_ORDER) {
    if(!Array.isArray(data.sections[section])) data.sections[section] = [];

    const wrap = document.createElement("div");
    wrap.className = "section";

    const head = document.createElement("div");
    head.className = "sectionHead";

    const count = data.sections[section].length;

    head.innerHTML = `
      <div class="sectionTitle">
        <h2>${section}</h2>
        <span>${count} √≠tem${count !== 1 ? "s" : ""}</span>
      </div>
      <button class="btnPlus" onclick="addItem('${section}')">‚ûï Agregar</button>
    `;
    wrap.appendChild(head);

    const list = document.createElement("div");
    list.className = "items";

    let sectionExpected = 0;
    let sectionSpent = 0;
    let sectionCardSpent = 0;

    data.sections[section].forEach((item, index) => {
      const row = document.createElement("div");
      row.className = `item ${item.status}`;

      const badge = item.status === "spent"
        ? `<span class="badge badgeSpent">Gastado</span>`
        : `<span class="badge badgeExpected">Esperado</span>`;

      const payBadge = (item.payment === "card")
        ? `<span class="badge badgeCard">üí≥ Tarjeta</span>`
        : "";

      row.innerHTML = `
        <div class="itemDesc">
          <div class="name">${item.desc}</div>
          <div class="sub">
            ${badge}
            ${payBadge}
            <span>Actualizado: ${fmtDate(item.updatedAt)}</span>
            <span>Click para editar</span>
          </div>
        </div>
        <div class="priceChip"><small>USD</small><span>${fmtMoney(item.amount)}</span></div>
      `;
      row.onclick = () => editItem(section, index);
      list.appendChild(row);

      const amt = Number(item.amount) || 0;
      if (item.status === "expected") sectionExpected += amt;
      if (item.status === "spent") {
        sectionSpent += amt;
        if (item.payment === "card") sectionCardSpent += amt;
      }
    });

    wrap.appendChild(list);

    const sectionTotalAll = sectionExpected + sectionSpent;

    const totals = document.createElement("div");
    totals.className = "sectionTotals";
    totals.innerHTML = `
      <div class="tCard tSpent">
        <div class="label"><span>üî¥ Gastado</span><span>Secci√≥n</span></div>
        <div class="value">USD ${fmtMoney(sectionSpent)}</div>
      </div>

      <div class="tCard tCardCard">
        <div class="label"><span>üí≥ Tarjeta</span><span>Secci√≥n</span></div>
        <div class="value">USD ${fmtMoney(sectionCardSpent)}</div>
      </div>

      <div class="tCard tExpected">
        <div class="label"><span>üü° Esperado</span><span>Secci√≥n</span></div>
        <div class="value">USD ${fmtMoney(sectionExpected)}</div>
      </div>

      <div class="tCard tAll">
        <div class="label"><span>Total</span><span>Secci√≥n</span></div>
        <div class="value">USD ${fmtMoney(sectionTotalAll)}</div>
      </div>
    `;
    wrap.appendChild(totals);

    app.appendChild(wrap);
  }
}

/* ==========================
   CRUD ITEMS
========================== */
function addItem(section) {
  const desc = prompt("Descripci√≥n del gasto:");
  const amount = parseFloat(prompt("Monto USD:"));
  if (!desc || isNaN(amount)) return;

  const pay = prompt("Pago (cash/card):", "cash");

  data.sections[section].push({
    desc: cleanDesc(desc),
    amount,
    status: "expected",
    payment: (String(pay || "").toLowerCase() === "card") ? "card" : "cash",
    updatedAt: nowISO()
  });

  save();
  render();
}

function editItem(section, index) {
  const item = data.sections[section][index];

  const action = prompt(
    "Escrib√≠:\n1 = Editar\n2 = Marcar como gastado\n3 = Volver a esperado\n4 = Eliminar\n5 = Cambiar pago (cash/card)",
    "1"
  );

  if (action === "1") {
    const newDesc = prompt("Descripci√≥n:", item.desc);
    const newAmount = parseFloat(prompt("Monto USD:", item.amount));
    if (!newDesc || isNaN(newAmount)) return;

    item.desc = cleanDesc(newDesc);
    item.amount = newAmount;

    const pay = prompt("Pago (cash/card):", item.payment || "cash");
    item.payment = (String(pay || "").toLowerCase() === "card") ? "card" : "cash";

    item.updatedAt = nowISO();
  }

  if (action === "2") {
    item.status = "spent";
    const pay = prompt("¬øC√≥mo pagaste? (cash/card):", item.payment || "cash");
    item.payment = (String(pay || "").toLowerCase() === "card") ? "card" : "cash";
    item.updatedAt = nowISO();
  }

  if (action === "3") {
    item.status = "expected";
    item.updatedAt = nowISO();
  }

  if (action === "5") {
    item.payment = (item.payment === "card") ? "cash" : "card";
    item.updatedAt = nowISO();
  }

  if (action === "4") {
    const ok = confirm("¬øEliminar este √≠tem?");
    if(ok) data.sections[section].splice(index, 1);
  }

  save();
  render();
}

function resetData(){
  const ok = confirm("¬øResetear todo a valores por defecto?");
  if(!ok) return;
  data = JSON.parse(JSON.stringify(dataDefault));
  data = migrateToCategoriesIfNeeded(data);
  save();
  render();
}

/* ==========================
   SNAPSHOT / JSON
========================== */
function getSnapshot() {
  return {
    version: 2,
    savedAt: new Date().toISOString(),
    budgetUSD: budgetUSD || 0,
    data
  };
}

function downloadJSON() {
  const snapshot = getSnapshot();
  const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `viaje_backup_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
}

function triggerImport() {
  const input = document.getElementById("importFile");
  input.value = "";
  input.click();
}

document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("importFile");
  if (!input) return;

  input.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      const text = await file.text();
      const snapshot = JSON.parse(text);

      // soporte por si import√°s un JSON viejo
      if (snapshot.data && snapshot.budgetUSD !== undefined) {
        data = snapshot.data;
        budgetUSD = Number(snapshot.budgetUSD) || 0;
      } else if (snapshot.sections) {
        data = { sections: snapshot.sections };
      } else {
        throw new Error("Formato inv√°lido");
      }

      data = migrateToCategoriesIfNeeded(data);

      save();
      render();
      alert("‚úÖ Importado OK");
    } catch (err) {
      alert("‚ùå No pude importar ese archivo JSON. Asegurate de que sea un backup v√°lido.");
    }
  });

  // primera render
  render();
});

/* ==========================
   EXPORT PDF
========================== */
function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });

  const marginX = 40;
  let y = 48;

  const totals = computeTotals();
  const generatedAt = new Date().toLocaleString("es-AR");
  const remaining = (budgetUSD || 0) - totals.spent;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("Viaje ‚Äì Control de Gastos", marginX, y);

  y += 18;
  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
  doc.text(`Generado: ${generatedAt}`, marginX, y);

  y += 16;
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text(
    `Gastado: USD ${fmtMoney(totals.spent)} | Tarjeta: USD ${fmtMoney(totals.cardSpent)} | Esperado: USD ${fmtMoney(totals.expected)} | Total: USD ${fmtMoney(totals.total)}`,
    marginX,
    y
  );

  y += 14;
  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
  doc.text(`Dinero inicial: USD ${fmtMoney(budgetUSD || 0)} | Te queda: USD ${fmtMoney(remaining)}`, marginX, y);

  y += 18;

  for(const section of CATEGORY_ORDER){
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text(section, marginX, y);
    y += 10;

    const rows = (data.sections[section] || []).map(it => ([
      it.desc,
      (it.status === "spent" ? "Gastado" : "Esperado"),
      (it.payment === "card" ? "Tarjeta" : "Cash"),
      `USD ${fmtMoney(it.amount)}`,
      fmtDate(it.updatedAt)
    ]));

    doc.autoTable({
      startY: y,
      head: [["Detalle", "Estado", "Pago", "Monto", "√öltima actualizaci√≥n"]],
      body: rows,
      styles: { font: "helvetica", fontSize: 9, cellPadding: 6 },
      headStyles: { fillColor: [30, 41, 59] },
      columnStyles: { 3: { halign: "right" } },
      margin: { left: marginX, right: marginX }
    });

    y = doc.lastAutoTable.finalY + 18;

    if(y > 740){
      doc.addPage();
      y = 48;
    }
  }

  doc.save(`viaje_gastos_${new Date().toISOString().slice(0,10)}.pdf`);
}
</script>

</body>
</html>
